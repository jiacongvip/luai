# 🚀 项目启动方式详细说明

## 📌 问题背景

你可能遇到过这样的困惑：
- 用 `docker-compose up -d` 启动项目后，流式输出不工作
- 但是直接用 `npm run dev` 启动就一切正常

这份文档将详细解释原因，并告诉你正确的启动方式。

---

## 🤔 为什么会这样？

### 简单比喻

想象你有一个**菜谱**（代码），你可以用两种方式做菜：

1. **方式 A：现做现吃**（npm run dev）
   - 每次做菜都按照**最新的菜谱**来做
   - 菜谱更新了，下次做的菜就会不同

2. **方式 B：预制菜**（Docker）
   - 提前按照菜谱做好一批预制菜，装进盒子里
   - 每次吃的都是**盒子里装好的菜**
   - 即使菜谱更新了，盒子里的菜还是旧的
   - 想吃新菜？必须**重新做一批装进盒子**

### 技术解释

```
┌─────────────────────────────────────────────────────────────────┐
│                        你的项目目录                               │
│                                                                 │
│   📁 backend/                                                   │
│   ├── 📁 src/           ← 最新的源代码（修复了流式输出）           │
│   └── 📁 dist/          ← 编译后的代码                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Docker 容器（独立的盒子）                      │
│                                                                 │
│   📦 nexus-backend 容器                                         │
│   └── 里面装的是【构建时】的代码副本                              │
│       （可能是几天前、几周前的旧代码）                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**关键点**：
- Docker 容器是一个**独立的"盒子"**
- 盒子里装的代码是**构建 Docker 镜像时**复制进去的
- 你在本地修改的代码，**不会自动同步到盒子里**
- 所以用 Docker 启动，运行的是**旧代码**

---

## 🏗️ 项目架构说明

本项目有 3 个部分：

```
┌────────────────┐     ┌────────────────┐     ┌────────────────┐
│                │     │                │     │                │
│    前端        │────▶│    后端        │────▶│   数据库       │
│  (React/Vite)  │     │  (Node.js)     │     │  (PostgreSQL)  │
│                │     │                │     │                │
│  端口: 4000    │     │  端口: 3001    │     │  端口: 5432    │
│                │     │                │     │                │
└────────────────┘     └────────────────┘     └────────────────┘
     浏览器访问            处理 API 请求          存储数据
```

### 每个部分的作用

| 组件 | 作用 | 是否需要用 Docker？ |
|------|------|-------------------|
| **前端** | 用户界面，你在浏览器看到的页面 | ❌ 不需要，直接 npm run dev |
| **后端** | 处理业务逻辑，调用 AI API | ⚠️ 开发时不建议，推荐 npm run dev |
| **数据库** | 存储用户、消息等数据 | ✅ 推荐用 Docker，方便管理 |

---

## ✅ 正确的启动方式

### 开发环境（推荐）

```bash
# 第一步：启动数据库（用 Docker）
docker-compose up -d postgres

# 第二步：启动后端（直接用 npm，使用最新代码）
cd backend
npm run dev

# 第三步：新开一个终端，启动前端
cd /path/to/nexus-agent-orchestrator
npm run dev
```

### 为什么这样启动？

| 组件 | 启动方式 | 原因 |
|------|---------|------|
| **数据库** | Docker | 数据库代码不会修改，用 Docker 方便 |
| **后端** | npm run dev | 后端代码经常修改，需要用最新代码 |
| **前端** | npm run dev | 前端代码经常修改，需要用最新代码 |

---

## ❌ 错误的启动方式

```bash
# 这样启动会使用 Docker 容器中的旧代码！
docker-compose up -d
```

这条命令会启动：
- ✅ postgres（数据库）- 这个没问题
- ❌ backend（后端）- 这个用的是旧代码！

### 如果你已经用错误方式启动了怎么办？

```bash
# 停止 Docker 中的后端
docker-compose stop backend

# 然后用 npm 启动后端
cd backend
npm run dev
```

---

## 📋 完整启动流程（一步步来）

### 准备工作

确保你已安装：
- Node.js（版本 18 或以上）
- Docker Desktop（已启动）

### 步骤 1：打开终端，进入项目目录

```bash
cd /Users/jiacongdediannao/Desktop/我的工具以及项目/项目/陆总ai/nexus-agent-orchestrator
```

### 步骤 2：启动数据库

```bash
docker-compose up -d postgres
```

等待几秒，看到类似这样的输出表示成功：
```
✔ Container nexus-postgres  Started
```

### 步骤 3：启动后端

```bash
cd backend
npm run dev
```

看到这样的输出表示成功：
```
🚀 Server running on http://localhost:3001
📡 API available at http://localhost:3001/api
✅ Database connected
✅ WebSocket server initialized on /ws
```

### 步骤 4：新开一个终端，启动前端

```bash
cd /Users/jiacongdediannao/Desktop/我的工具以及项目/项目/陆总ai/nexus-agent-orchestrator
npm run dev
```

看到这样的输出表示成功：
```
VITE v6.4.1  ready in 163 ms

➜  Local:   http://localhost:4000/
➜  Network: http://192.168.2.67:4000/
```

### 步骤 5：访问应用

打开浏览器，访问：http://localhost:4000

---

## 🔄 如果想用 Docker 运行所有服务

如果你想用 Docker 运行包括后端在内的所有服务，需要**重新构建 Docker 镜像**来包含最新代码：

```bash
# 重新构建并启动（包含最新代码）
docker-compose up -d --build
```

`--build` 参数会：
1. 读取最新的代码
2. 重新构建 Docker 镜像
3. 用新镜像启动容器

**注意**：每次代码修改后，都需要重新 `--build` 才能生效。这在开发时很麻烦，所以**开发时推荐直接用 npm run dev**。

---

## 📊 总结对比

| 场景 | 启动命令 | 优点 | 缺点 |
|------|---------|------|------|
| **开发调试** | `npm run dev` | 代码实时更新，修改立即生效 | 需要分别启动前后端 |
| **生产部署** | `docker-compose up -d --build` | 一键启动，环境一致 | 代码修改需要重新构建 |
| **错误方式** | `docker-compose up -d` | - | 使用旧代码，修改不生效 |

---

## 🆘 常见问题

### Q: 为什么我修改了代码但没有生效？

**A**: 检查你是否用 Docker 启动了后端。如果是，请停止 Docker 后端，改用 `npm run dev`。

```bash
docker-compose stop backend
cd backend && npm run dev
```

### Q: 数据库连接失败怎么办？

**A**: 确保 Docker Desktop 已启动，然后运行：

```bash
docker-compose up -d postgres
```

### Q: 端口被占用怎么办？

**A**: 查看并关闭占用端口的进程：

```bash
# 查看 3001 端口（后端）
lsof -i :3001

# 查看 4000 端口（前端）
lsof -i :4000

# 关闭进程（把 PID 换成实际的进程 ID）
kill -9 PID
```

### Q: 如何完全停止所有服务？

**A**: 

```bash
# 停止 Docker 服务
docker-compose down

# 停止 npm 启动的服务
# 在对应终端按 Ctrl + C
```

---

## 📝 快速参考卡片

```
┌─────────────────────────────────────────────────────────────┐
│                     日常开发启动步骤                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. docker-compose up -d postgres    # 启动数据库          │
│                                                             │
│  2. cd backend && npm run dev        # 启动后端            │
│                                                             │
│  3. (新终端) npm run dev             # 启动前端            │
│                                                             │
│  4. 浏览器访问 http://localhost:4000                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 💡 记住这个原则

> **开发时**：Docker 只用来跑数据库，前后端用 `npm run dev`
> 
> **部署时**：用 `docker-compose up -d --build` 一键部署

这样就不会再遇到"代码修改了但不生效"的问题了！

---

*最后更新：2026年1月7日*

